{% extends "base.html" %}
{% load static %}
{% load i18n %}

{% block title %}{% trans "APD Submission" %}{% endblock %}

{% block extra_css %}
<style>
    :root {
        --glass-bg: rgba(255, 255, 255, 0.85);
        --glass-border: rgba(255, 255, 255, 0.4);
        --card-shadow: 0 8px 32px 0 rgba(31, 38, 135, 0.06);
        --card-radius: 20px;
        --primary-gradient: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%);
    }

    .modern-card {
        border-radius: var(--card-radius);
        border: 1px solid var(--glass-border);
        background: var(--glass-bg);
        backdrop-filter: blur(12px);
        -webkit-backdrop-filter: blur(12px);
        padding: 2rem;
        position: relative;
        z-index: 1;
        transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        box-shadow: var(--card-shadow);
    }

    .submit-btn {
        background: var(--primary-gradient);
        border: none;
        padding: 0.8rem 2.5rem;
        border-radius: 12px;
        color: white;
        font-weight: 700;
        letter-spacing: 0.02em;
        transition: all 0.3s;
        box-shadow: 0 4px 12px rgba(37, 99, 235, 0.2);
    }

    .submit-btn:hover {
        transform: translateY(-2px);
        box-shadow: 0 6px 20px rgba(37, 99, 235, 0.3);
        background: linear-gradient(135deg, #2563eb 0%, #1d4ed8 100%);
    }

    .period-badge {
        background: #eff6ff;
        color: #2563eb;
        padding: 0.5rem 1.25rem;
        border-radius: 100px;
        font-weight: 700;
        display: inline-flex;
        align-items: center;
        gap: 0.5rem;
    }

    .status-badge {
        padding: 0.5rem 1rem;
        border-radius: 100px;
        font-weight: 700;
        font-size: 0.75rem;
        text-transform: uppercase;
        letter-spacing: 0.05em;
    }

    .status-accepted {
        background: rgba(16, 185, 129, 0.1);
        color: #059669;
    }

    /* Validation Toast Styles */
    .validation-toast {
        position: fixed;
        top: 2rem;
        right: 2rem;
        z-index: 10000;
        min-width: 350px;
        box-shadow: 0 10px 40px rgba(0,0,0,0.15);
        transition: all 0.5s cubic-bezier(0.4, 0, 0.2, 1);
        transform: translateX(0);
        opacity: 1;
        border: none;
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 1rem 1.25rem;
    }

    .toast-hidden {
        transform: translateX(120%);
        opacity: 0;
        pointer-events: none;
    }

    .validation-toast .btn-close {
        filter: brightness(0) invert(1);
        padding: 0.5rem;
        margin: -0.5rem -0.5rem -0.5rem 0.5rem;
        opacity: 0.8;
    }

    .validation-toast .btn-close:hover {
        opacity: 1;
    }

    /* Modal Highlights */
    .table-success-subtle {
        background-color: rgba(25, 135, 84, 0.08) !important;
    }
    
    .table-success-subtle:hover {
        background-color: rgba(25, 135, 84, 0.12) !important;
    }
</style>
{% endblock %}

{% block content %}
<div class="container py-4">
    <!-- Validation Toast (Rendered outside form) -->
    <div id="triple-validation-status" class="alert validation-toast toast-hidden" style="border-radius: 12px; font-weight: 600; font-size: 0.85rem;">
        <div class="d-flex align-items-center">
            <i class="bi me-2"></i>
            <span class="status-text"></span>
        </div>
        <button type="button" class="btn-close" aria-label="Close"></button>
    </div>

    <!-- Selection Modal -->
    <div class="modal fade" id="codeSelectionModal" tabindex="-1" aria-labelledby="codeSelectionModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-xl modal-dialog-centered modal-dialog-scrollable">
            <div class="modal-content border-0 shadow-lg" style="border-radius: 20px; overflow: hidden;">
                <div class="modal-header bg-dark text-white p-4 border-0">
                    <div class="d-flex align-items-center">
                        <div class="icon-circle bg-primary bg-opacity-25 text-primary me-3 mb-0" style="width: 40px; height: 40px; font-size: 1.2rem;">
                            <i class="bi bi-search"></i>
                        </div>
                        <div>
                            <h5 class="modal-title fw-bold" id="codeSelectionModalLabel">Select Code</h5>
                            <p class="text-white-50 small mb-0" id="modal-subtitle">Browse and pick the most suitable option</p>
                        </div>
                    </div>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body p-0">
                    <div class="p-4 bg-light border-bottom">
                        <div class="input-group">
                            <span class="input-group-text border-0 bg-white" style="border-radius: 12px 0 0 12px;">
                                <i class="bi bi-filter text-muted"></i>
                            </span>
                            <input type="text" id="modal-search" class="form-control border-0 p-3" placeholder="Search by code or description..." style="border-radius: 0 12px 12px 0;">
                        </div>
                        <div class="mt-3 d-flex gap-4 small fw-bold">
                            <div class="d-flex align-items-center">
                                <span class="badge bg-success rounded-circle p-1 me-2" style="width: 10px; height: 10px;">&nbsp;</span>
                                <span class="text-success">Recommended</span>
                            </div>
                            <div class="d-flex align-items-center">
                                <span class="badge bg-secondary rounded-circle p-1 me-2" style="width: 10px; height: 10px;">&nbsp;</span>
                                <span class="text-muted">Standard Options</span>
                            </div>
                        </div>
                    </div>
                    <div class="table-responsive" style="max-height: 450px;">
                        <table class="table table-hover align-middle mb-0">
                            <thead class="sticky-top bg-white shadow-sm">
                                <tr>
                                    <th class="border-0 px-4 py-3 small text-muted text-uppercase fw-bold" style="width: 120px;">Code</th>
                                    <th class="border-0 px-4 py-3 small text-muted text-uppercase fw-bold">Description</th>
                                    <th class="border-0 px-4 py-3 small text-muted text-uppercase fw-bold text-end" style="width: 150px;">Action</th>
                                </tr>
                            </thead>
                            <tbody id="modal-table-body">
                                <!-- Dynamic Rows -->
                            </tbody>
                        </table>
                    </div>
                </div>
                <div class="modal-footer bg-light p-4 border-0">
                    <p class="text-muted small mb-0 me-auto">
                        <i class="bi bi-info-circle me-1"></i>
                        Recommended codes are filtered based on your existing form entries.
                    </p>
                    <button type="button" class="btn btn-light fw-bold px-4" data-bs-dismiss="modal" style="border-radius: 12px;">Cancel</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Header Section -->
    <div class="d-flex justify-content-between align-items-end mb-5">
        <div>
            <nav aria-label="breadcrumb" class="mb-2">
                <ol class="breadcrumb mb-0 small uppercase fw-bold" style="letter-spacing: 0.05em;">
                    <li class="breadcrumb-item"><a href="{% url 'employer_home' %}"
                            class="text-decoration-none">Dashboard</a></li>
                    <li class="breadcrumb-item active text-muted" aria-current="page">APD Submission</li>
                </ol>
            </nav>
            <span class="badge bg-primary bg-opacity-10 text-primary px-3 py-2 rounded-pill small fw-bold mb-3">
                {% trans "Employer Services" %}
            </span>
            <h1 class="display-6 fw-bold mb-1">{% trans "APD Submission" %}</h1>
            <p class="text-muted mb-0">{{ company_name }} (AME: {{ ame }})</p>
            <p class="text-muted small mb-0"><i class="bi bi-geo-alt me-1"></i>{{ company_address }}</p>
        </div>
        <div class="text-end">
            <div class="period-badge mb-1">
                <i class="bi bi-calendar3"></i>
                {% trans "Filing Period" %}: {{ current_period }}
            </div>
        </div>
    </div>

    <div class="row">
        <!-- Submission Form -->
        <div class="col-lg-12 mb-4">
            <div class="modern-card">
                <div class="d-flex align-items-center mb-4">
                    <div class="icon-circle bg-primary bg-opacity-10 text-primary me-3">
                        <i class="bi bi-file-earmark-text"></i>
                    </div>
                    <h5 class="fw-bold mb-0">{% trans "Declaration Entry" %}</h5>
                    <button type="button" class="btn btn-outline-primary ms-auto d-flex align-items-center" id="auto-fill-btn" disabled>
                        <i class="bi bi-magic me-2"></i>{% trans "Auto-fill" %}
                    </button>
                    <!-- Bulk Upload Button -->
                    <button class="btn btn-outline-primary ms-2 d-flex align-items-center rounded-pill px-4">
                        <i class="bi bi-cloud-upload me-2"></i>{% trans "Bulk Upload" %}
                    </button>
                </div>

                <form action="#" method="POST" novalidate>
                    {% csrf_token %}

                    <!-- General & Insured Party Info -->
                    <div class="row g-4 mb-4">
                        <div class="col-md-2">
                            <label class="form-label small fw-bold text-muted text-uppercase">{% trans "Branch" %}</label>
                            <input type="text" class="form-control border-0 bg-light p-3" value="000"
                                style="border-radius: 12px;">
                        </div>
                        <div class="col-md-3">
                            <label class="form-label small fw-bold text-muted text-uppercase d-flex align-items-center">
                                {% trans "Activity (KAD)" %}
                                <a href="javascript:void(0)" onclick="openCodeModal('kad')" class="ms-2 text-primary">
                                    <i class="bi bi-info-circle"></i>
                                </a>
                            </label>
                            <input type="text" id="kad-input" list="kad-history" class="form-control border-0 bg-light p-3" style="border-radius: 12px;" required
                                placeholder="e.g. 6201" maxlength="4">
                            <datalist id="kad-history"></datalist>
                            <small id="kad-description" class="text-muted mt-1 d-block" style="font-size: 0.75rem; line-height: 1.3;"></small>
                        </div>
                        <div class="col-md-3">
                            <label class="form-label small fw-bold text-muted text-uppercase">{% trans "Insurance No (AMA)" %}</label>
                            <input type="text" id="ama-input" class="form-control border-0 bg-light p-3" style="border-radius: 12px;" required placeholder="10 digits">
                        </div>
                        <div class="col-md-4">
                            <label class="form-label small fw-bold text-muted text-uppercase">{% trans "Social Security (AMKA)" %}</label>
                            <input type="text" class="form-control border-0 bg-light p-3" style="border-radius: 12px;" required placeholder="11 digits">
                        </div>
                    </div>

                    <div class="row g-4 mb-4">
                        <div class="col-md-6">
                            <label class="form-label small fw-bold text-muted text-uppercase">{% trans "Surname" %}</label>
                            <input type="text" class="form-control border-0 bg-light p-3" style="border-radius: 12px;">
                        </div>
                        <div class="col-md-6">
                            <label class="form-label small fw-bold text-muted text-uppercase">{% trans "Name" %}</label>
                            <input type="text" class="form-control border-0 bg-light p-3" style="border-radius: 12px;">
                        </div>
                    </div>

                    <hr class="my-4 opacity-50">

                    <!-- Insurance & Time Details -->
                    <div class="row g-4 mb-4">
                        <div class="col-md-3">
                            <label class="form-label small fw-bold text-muted text-uppercase d-flex align-items-center">
                                {% trans "Specialty Code" %}
                                <a href="javascript:void(0)" onclick="openCodeModal('eid')" class="ms-2 text-primary">
                                    <i class="bi bi-info-circle"></i>
                                </a>
                            </label>
                            <input type="text" id="eid-input" list="eid-history" class="form-control border-0 bg-light p-3" style="border-radius: 12px;" required
                                placeholder="e.g. 213120">
                            <datalist id="eid-history"></datalist>
                            <small id="eid-description" class="text-muted mt-1 d-block" style="font-size: 0.75rem; line-height: 1.3;"></small>
                        </div>
                        <div class="col-md-3">
                            <label class="form-label small fw-bold text-muted text-uppercase d-flex align-items-center">
                                {% trans "Coverage Package" %}
                                <a href="javascript:void(0)" onclick="openCodeModal('kpk')" class="ms-2 text-primary">
                                    <i class="bi bi-info-circle"></i>
                                </a>
                            </label>
                            <input type="text" id="kpk-input" list="kpk-history" class="form-control border-0 bg-light p-3" style="border-radius: 12px;" required
                                placeholder="e.g. 101">
                            <datalist id="kpk-history"></datalist>
                            <small id="kpk-description" class="text-muted mt-1 d-block" style="font-size: 0.75rem; line-height: 1.3;"></small>
                        </div>
                        <div class="col-md-3">
                            <label class="form-label small fw-bold text-muted text-uppercase">{% trans "Earnings Type" %}</label>
                            <select class="form-select border-0 bg-light p-3" style="border-radius: 12px;">
                                <option value="01">{% trans "01 - Ordinary" %}</option>
                                <option value="03">{% trans "03 - Christmas Bonus" %}</option>
                                <option value="04">{% trans "04 - Easter Bonus" %}</option>
                            </select>
                        </div>
                        <div class="col-md-3">
                            <label class="form-label small fw-bold text-muted text-uppercase">{% trans "Insurance Days" %}</label>
                            <input type="number" id="insurance-days" class="form-control border-0 bg-light p-3" style="border-radius: 12px;" required placeholder="25">
                        </div>
                    </div>



                    <hr class="my-4 opacity-50">

                    <!-- Financials -->
                    <div class="row g-4 mb-5">
                        <div class="col-md-6">
                            <label class="form-label small fw-bold text-muted text-uppercase">{% trans "Gross Earnings" %}</label>
                            <div class="input-group">
                                <input type="number" id="gross-earnings" step="0.01" class="form-control border-0 bg-light p-3" required
                                    style="border-top-left-radius: 12px; border-bottom-left-radius: 12px;">
                                <span class="input-group-text border-0 bg-light px-3"
                                    style="border-top-right-radius: 12px; border-bottom-right-radius: 12px;">€</span>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <label class="form-label small fw-bold text-muted text-uppercase">{% trans "Total Contributions" %}</label> 
                            <div class="input-group">
                                <input type="number" id="total-contributions" step="0.01" class="form-control border-0 bg-light p-3" required
                                    style="border-top-left-radius: 12px; border-bottom-left-radius: 12px;">
                                <span class="input-group-text border-0 bg-light px-3"
                                    style="border-top-right-radius: 12px; border-bottom-right-radius: 12px;">€</span>
                            </div>
                        </div>
                    </div>

                    <div id="financial-error" class="alert alert-danger d-none mt-3" role="alert">
                        <i class="bi bi-exclamation-triangle-fill me-2"></i>
                        <span id="financial-error-msg">{% trans "Gross Earnings and Total Contributions must be positive values." %}</span>
                    </div>

                    <div class="d-flex gap-3 mt-4">
                        <button type="submit" id="submit-declaration-btn" class="submit-btn flex-grow-1">
                            <i class="bi bi-check-circle-fill me-2"></i>{% trans "Save Declaration" %}
                        </button>
                        <button type="reset" class="btn btn-light px-4" style="border-radius: 12px; font-weight: 600;">
                            {% trans "Clear Form" %}
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Submission History -->
    <div class="modern-card mt-4">
        <h5 class="fw-bold mb-4">{% trans "Recent Submissions" %}</h5>
        <div class="table-responsive">
            <table class="table table-hover align-middle mb-0">
                <thead class="text-muted small text-uppercase fw-bold"
                    style="letter-spacing: 0.05em; background: #f8fafc;">
                    <tr>
                        <th class="border-0 px-3 py-3">{% trans "Period" %}</th>
                        <th class="border-0 px-3 py-3">{% trans "Submission Date" %}</th>
                        <th class="border-0 px-3 py-3">{% trans "Receipt #" %}</th>
                        <th class="border-0 px-3 py-3">{% trans "Employees" %}</th>
                        <th class="border-0 px-3 py-3">{% trans "Total Amount" %}</th>
                        <th class="border-0 px-3 py-3 text-center">{% trans "Status" %}</th>
                        <th class="border-0 px-3 py-3 text-end">{% trans "Actions" %}</th>
                    </tr>
                </thead>
                <tbody>
                    {% for sub in submission_history %}
                    <tr>
                        <td class="px-3 py-3 fw-bold">{{ sub.period }}</td>
                        <td class="px-3 py-3 text-muted">{{ sub.submission_date }}</td>
                        <td class="px-3 py-3 font-monospace small">{{ sub.receipt_number }}</td>
                        <td class="px-3 py-3">{{ sub.employee_count }}</td>
                        <td class="px-3 py-3 fw-bold">{{ sub.total_contributions|floatformat:2 }} €</td>
                        <td class="px-3 py-3 text-center">
                            <span class="status-badge status-accepted">
                                <i class="bi bi-check2-circle me-1"></i>{{ sub.status }}
                            </span>
                        </td>
                        <td class="px-3 py-3 text-end">
                            <button class="btn btn-sm btn-outline-primary rounded-pill px-3">
                                <i class="bi bi-download me-1"></i>{% trans "Receipt" %}
                            </button>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    // KAD code to description mapping
    let kadMapping = {};
    let specialtyMapping = {};
    let kpkMapping = {};
    let tripleMapping = new Set();

    // Helper to fetch and parse mapping files
    function loadMapping(url, mappingObj) {
        return fetch(url)
            .then(response => response.text())
            .then(text => {
                const lines = text.split('\n');
                lines.forEach(line => {
                    const parts = line.split('|');
                    if (parts.length >= 2) {
                        const code = parts[0].trim();
                        const description = parts[1].trim();
                        mappingObj[code] = description;
                    }
                });
            })
            .catch(error => {
                console.error(`Error loading mapping from ${url}:`, error);
            });
    }

    // Load all mappings
    loadMapping('{% static "core/texts/dn_kad.txt" %}', kadMapping);
    loadMapping('{% static "core/texts/dn_eid.txt" %}', specialtyMapping);
    loadMapping('{% static "core/texts/dn_kpk.txt" %}', kpkMapping);

    // Load triple mapping for KAD-EID-KPK validation
    fetch('{% static "core/texts/dn_kadeidkpk.txt" %}')
        .then(response => response.text())
        .then(text => {
            const lines = text.split('\n');
            lines.forEach(line => {
                const parts = line.split('|');
                if (parts.length >= 3) {
                    const kad = parts[0].trim();
                    const eid = parts[1].trim();
                    const kpk = parts[2].trim();
                    if (kad && eid && kpk) {
                        tripleMapping.add(`${kad}|${eid}|${kpk}`);
                    }
                }
            });
        })
        .catch(error => console.error('Error loading triple mapping:', error));

    // Handle input changes
    document.addEventListener('DOMContentLoaded', function() {
        const kadInput = document.getElementById('kad-input');
        const eidInput = document.getElementById('eid-input');
        const kpkInput = document.getElementById('kpk-input');
        const tripleStatus = document.getElementById('triple-validation-status');
        const statusText = tripleStatus ? tripleStatus.querySelector('.status-text') : null;
        const statusIcon = tripleStatus ? tripleStatus.querySelector('i') : null;
        const closeBtn = tripleStatus ? tripleStatus.querySelector('.btn-close') : null;
        let toastTimeout;

        if (closeBtn && tripleStatus) {
            closeBtn.addEventListener('click', () => {
                tripleStatus.classList.add('toast-hidden');
                if (toastTimeout) clearTimeout(toastTimeout);
            });
        }

        function updateTripleValidation() {
            if (!tripleStatus || !statusText) return;

            const kad = kadInput.value.trim();
            const eid = eidInput.value.trim();
            const kpk = kpkInput.value.trim();

            if (kad && eid && kpk) {
                const combo = `${kad}|${eid}|${kpk}`;
                const isValid = tripleMapping.has(combo);
                
                // Clear any existing timer
                if (toastTimeout) clearTimeout(toastTimeout);

                // Update content
                tripleStatus.classList.remove('alert-success', 'alert-danger', 'toast-hidden');
                tripleStatus.classList.add(isValid ? 'alert-success' : 'alert-danger');
                
                statusText.textContent = isValid 
                    ? '{% trans "Valid combination of KAD, Specialty, and Coverage Package" %}'
                    : '{% trans "Invalid combination of KAD, Specialty, and Coverage Package" %}';
                
                if (statusIcon) {
                    statusIcon.className = isValid 
                        ? 'bi bi-check-circle-fill me-2' 
                        : 'bi bi-exclamation-triangle-fill me-2';
                }

                // If valid, save to history and set auto-hide
                if (isValid) {
                    saveToHistory('kad-history', kad);
                    saveToHistory('eid-history', eid);
                    saveToHistory('kpk-history', kpk);
                    
                    toastTimeout = setTimeout(() => {
                        tripleStatus.classList.add('toast-hidden');
                    }, 4000);
                }
                // If invalid, it STICKS (no timeout set) until corrected or closed
            } else {
                tripleStatus.classList.add('toast-hidden');
            }
        }

        // History Management
        function loadHistory(datalistId) {
            const history = JSON.parse(localStorage.getItem(datalistId) || '[]');
            const datalist = document.getElementById(datalistId);
            if (datalist) {
                datalist.innerHTML = history.map(item => `<option value="${item}">`).join('');
            }
        }

        function saveToHistory(datalistId, value) {
            if (!value) return;
            let history = JSON.parse(localStorage.getItem(datalistId) || '[]');
            // Remove if already exists (to move to front), then add to front
            history = history.filter(item => item !== value);
            history.unshift(value);
            // Keep only last 5
            history = history.slice(0, 5);
            localStorage.setItem(datalistId, JSON.stringify(history));
            loadHistory(datalistId);
        }

        // Initialize history on load
        ['kad-history', 'eid-history', 'kpk-history'].forEach(id => loadHistory(id));

        function setupDescriptionLookup(inputId, descriptionId, mapping, unknownMsg) {
            const input = document.getElementById(inputId);
            const description = document.getElementById(descriptionId);

            if (input && description) {
                input.addEventListener('input', function() {
                    const code = this.value.trim();
                    if (code && mapping[code]) {
                        description.textContent = mapping[code];
                        description.classList.remove('text-danger');
                        description.classList.add('text-success');
                    } else if (code.length >= 3) { // Threshold for showing unknown message
                        description.textContent = unknownMsg;
                        description.classList.remove('text-success');
                        description.classList.add('text-danger');
                    } else {
                        description.textContent = '';
                    }
                    updateTripleValidation();
                    updateInfoLinks();
                });
            }
        }

        function updateInfoLinks() {
            // No longer needed as we use the modal, but kept for compatibility or other future links
        }

        // Modal selection logic for codes
        let currentModalType = 'kad';
        let modalData = [];

        window.openCodeModal = function(type) {
            currentModalType = type;
            const modal = new bootstrap.Modal(document.getElementById('codeSelectionModal'));
            const titleEl = document.getElementById('codeSelectionModalLabel');
            const subtitleEl = document.getElementById('modal-subtitle');
            
            const titles = {
                'kad': '{% trans "Select Activity (KAD)" %}',
                'eid': '{% trans "Select Specialty Code" %}',
                'kpk': '{% trans "Select Coverage Package" %}'
            };
            titleEl.textContent = titles[type];
            subtitleEl.textContent = `Browsing ${type.toUpperCase()} codes for your submission`;

            // Prepare data
            const mapping = type === 'kad' ? kadMapping : (type === 'eid' ? specialtyMapping : kpkMapping);
            const kadVal = kadInput.value.trim();
            const eidVal = eidInput.value.trim();
            const kpkVal = kpkInput.value.trim();

            const recommendedCodes = new Set();
            tripleMapping.forEach(combo => {
                const [k, e, p] = combo.split('|');
                let match = true;
                if (type !== 'kad' && kadVal && k !== kadVal) match = false;
                if (type !== 'eid' && eidVal && e !== eidVal) match = false;
                if (type !== 'kpk' && kpkVal && p !== kpkVal) match = false;

                if (match) {
                    if (type === 'kad') recommendedCodes.add(k);
                    else if (type === 'eid') recommendedCodes.add(e);
                    else if (type === 'kpk') recommendedCodes.add(p);
                }
            });

            modalData = Object.entries(mapping).map(([code, desc]) => ({
                code,
                desc,
                isRecommended: recommendedCodes.has(code)
            }));

            // Initial sort: Recommended first, then by code
            modalData.sort((a, b) => {
                if (a.isRecommended !== b.isRecommended) return b.isRecommended - a.isRecommended;
                return a.code.localeCompare(b.code);
            });

            renderModalTable();
            document.getElementById('modal-search').value = '';
            modal.show();
        };

        function renderModalTable(filter = '') {
            const container = document.getElementById('modal-table-body');
            const lowerFilter = filter.toLowerCase();
            
            const filtered = modalData.filter(item => 
                item.code.toLowerCase().includes(lowerFilter) || 
                item.desc.toLowerCase().includes(lowerFilter)
            );

            container.innerHTML = filtered.map(item => `
                <tr class="${item.isRecommended ? 'table-success-subtle' : 'opacity-50'}" 
                    style="${item.isRecommended ? 'cursor: pointer;' : 'cursor: not-allowed;'}" 
                    ${item.isRecommended ? `onclick="selectCode('${item.code}')"` : ''}>
                    <td class="px-4 py-4">
                        <span class="fw-bold font-monospace fs-5">${item.code}</span>
                        ${item.isRecommended ? '<i class="bi bi-star-fill text-success ms-2"></i>' : ''}
                    </td>
                    <td class="px-4 py-4 text-dark">${item.desc}</td>
                    <td class="px-4 py-4 text-end">
                        ${item.isRecommended 
                            ? `<button class="btn btn-success rounded-pill px-4 fw-bold">Recommended</button>` 
                            : `<span class="text-muted small fw-bold">Manual Entry Only</span>`
                        }
                    </td>
                </tr>
            `).join('');

            if (filtered.length === 0) {
                container.innerHTML = '<tr><td colspan="3" class="text-center py-5 text-muted">No results found</td></tr>';
            }
        }

        window.selectCode = function(code) {
            const inputMap = { 'kad': kadInput, 'eid': eidInput, 'kpk': kpkInput };
            const input = inputMap[currentModalType];
            if (input) {
                input.value = code;
                // Trigger input event to update descriptions and validation
                input.dispatchEvent(new Event('input'));
            }
            bootstrap.Modal.getInstance(document.getElementById('codeSelectionModal')).hide();
        };

        document.getElementById('modal-search').addEventListener('input', (e) => {
            renderModalTable(e.target.value);
        });

        setupDescriptionLookup('kad-input', 'kad-description', kadMapping, '{% trans "Unknown KAD code" %}');
        setupDescriptionLookup('eid-input', 'eid-description', specialtyMapping, '{% trans "Unknown Specialty code" %}');
        setupDescriptionLookup('kpk-input', 'kpk-description', kpkMapping, '{% trans "Unknown Coverage Package code" %}');
        
        // Initial build of links
        updateInfoLinks();

        // Handle form reset
        const form = document.querySelector('form');
        // Form Submission Validation
        const submitBtn = document.getElementById('submit-declaration-btn');
        const financialError = document.getElementById('financial-error');
        const grossEarningsInput = document.getElementById('gross-earnings');
        const totalContributionsInput = document.getElementById('total-contributions');
        
        // Find the specific form that contains the submit button
        const actualForm = submitBtn ? submitBtn.closest('form') : null;

        if (actualForm) {
            actualForm.addEventListener('submit', function(e) {
                const gross = parseFloat(grossEarningsInput.value);
                const contrib = parseFloat(totalContributionsInput.value);
                
                // --- REQUIRED FIELDS VALIDATION ---
                // Validation for all required fields
                const requiredInputs = actualForm.querySelectorAll('input[required], select[required]');
                let missingFields = false;
                
                requiredInputs.forEach(input => {
                    if (!input.value.trim()) {
                        missingFields = true;
                        input.classList.add('is-invalid');
                    } else {
                        input.classList.remove('is-invalid');
                    }
                });

                if (missingFields) {
                    e.preventDefault();
                    document.getElementById('financial-error-msg').textContent = '{% trans "Please fill in all required fields." %}';
                    financialError.classList.remove('d-none');
                    financialError.scrollIntoView({ behavior: 'smooth', block: 'center' });
                    return; // Stop further validation if fields are missing
                }

                // --- FINANCIAL VALIDATION ---
                let isValid = true;
                
                financialError.classList.add('d-none');
                grossEarningsInput.classList.remove('is-invalid');
                totalContributionsInput.classList.remove('is-invalid');

                if (isNaN(gross) || gross < 0) {
                    isValid = false;
                    grossEarningsInput.classList.add('is-invalid');
                }

                if (isNaN(contrib) || contrib < 0) {
                    isValid = false;
                    totalContributionsInput.classList.add('is-invalid');
                }

                if (!isValid) {
                    e.preventDefault();
                    document.getElementById('financial-error-msg').textContent = '{% trans "Gross Earnings and Total Contributions must be positive values." %}';
                    financialError.classList.remove('d-none');
                    // Scroll to error
                    financialError.scrollIntoView({ behavior: 'smooth', block: 'center' });
                }
            });
        }
        
        // Auto-fill integration
        const amaInput = document.getElementById('ama-input');
        const autoFillBtn = document.getElementById('auto-fill-btn');
        const insuranceDaysInput = document.getElementById('insurance-days');

        if (amaInput && autoFillBtn) {
            amaInput.addEventListener('input', function() {
                if (this.value.trim().length > 0) {
                   autoFillBtn.disabled = false;
                } else {
                   autoFillBtn.disabled = true;
                }
            });

            autoFillBtn.addEventListener('click', function() {
                const ama = amaInput.value.trim();
                if (!ama) return;

                // Show loading state
                const originalContent = this.innerHTML;
                this.innerHTML = '<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span> Loading...';
                this.disabled = true;

                fetch(`{% url 'get_last_contribution' %}?ama=${ama}`)
                    .then(response => {
                        if (!response.ok) {
                            return response.json().then(err => { throw new Error(err.error || 'Fetch error') });
                        }
                        return response.json();
                    })
                    .then(data => {
                        if (data) {
                            if (data.coverage_package_id) kpkInput.value = data.coverage_package_id;
                            if (data.earning_type_id) {
                                // Match earnings type with available options
                            }
                            if (data.insurance_days) insuranceDaysInput.value = data.insurance_days;
                            if (data.gross_earnings) grossEarningsInput.value = data.gross_earnings;
                            if (data.total_contribution) totalContributionsInput.value = data.total_contribution;

                            // Trigger events for dependent logic
                            kpkInput.dispatchEvent(new Event('input'));
                            grossEarningsInput.dispatchEvent(new Event('input'));
                            totalContributionsInput.dispatchEvent(new Event('input'));
                            
                            // Success visual
                            this.classList.remove('btn-outline-primary');
                            this.classList.add('btn-success');
                            setTimeout(() => {
                                this.classList.remove('btn-success');
                                this.classList.add('btn-outline-primary');
                            }, 2000);
                        }
                    })
                    .catch(error => {
                        console.error('Auto-fill error:', error);
                        alert(error.message); // User notification on fetch error
                    })
                    .finally(() => {
                        this.innerHTML = originalContent;
                        this.disabled = false;
                    });
            });
        }

        // Live Validation Clear
        [grossEarningsInput, totalContributionsInput].forEach(input => {
            if (input) {
                input.addEventListener('input', function() {
                    const val = parseFloat(this.value);
                    if (!isNaN(val) && val >= 0) {
                        this.classList.remove('is-invalid');
                        if (!document.querySelector('.is-invalid')) {
                            financialError.classList.add('d-none');
                        }
                    }
                });
            }
        });

    });
</script>
{% endblock %}